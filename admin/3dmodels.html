<!DOCTYPE html>
<html>

<head>
    <title>Projects</title>
    <style>
        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        input[type="text"] {
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <h1>Models</h1>
    <div id="table-container">
    </div>
    <br></br>
    <button id="addModelBtn">Добавить модель</button>
    <br></br>
    <button id="back">К проектам</button>
    <br></br>
    <button id="logOutBtn">Выйти</button>
    <script>
        // Получение токена из sessionStorage
        const token = sessionStorage.token;
        const URLParams = new URLSearchParams(window.location.search);
        const projectId = URLParams.get('ProjectId');

        // Проверка наличия токена и значения projectId
        if (!token || !projectId) {
            window.history.back();
        }
        else {
            document.getElementById('addModelBtn').addEventListener('click', addModel);
            document.getElementById('logOutBtn').addEventListener('click', logOut);
            document.getElementById('back').addEventListener('click', function () { window.history.back(); });
            // Отправка запроса на сервер с заголовком Authorization содержащим токен
            refreshTable();
        }

        function refreshTable() {
            fetch('http://localhost:3000/models', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json;charset=UTF-8',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ projectId })
            })
                .then(response => response.json())
                .then(catalog => {
                    console.log(JSON.stringify(catalog));
                    drawTable(catalog);
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function drawTable(tableData) {
            const tableContainer = document.getElementById('table-container');
            tableContainer.innerHTML = '';

            // Создать таблицу
            const table = document.createElement('table');

            const exclude = ['model_id', 'owner_project_id'];
            const keys = Object.keys(tableData[0]).filter(key => !exclude.includes(key));

            // Создать заголовок таблицы
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            keys.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });

            // Создание столбцов для кнопок
            const buttons = ['Предпросмотр', 'К вариантам', 'Удалить'];

            buttons.forEach(buttonText => {
                const th = document.createElement('th');
                th.textContent = buttonText;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Создать тело таблицы
            const tbody = document.createElement('tbody');
            tableData.forEach(rowData => {
                const row = document.createElement('tr');

                keys.forEach(key => {
                    const td = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = rowData[key];
                    td.appendChild(input);
                    row.appendChild(td);
                });

                buttons.forEach((buttonText, index) => {
                    const td = document.createElement('td');
                    const button = document.createElement('button');
                    button.textContent = buttonText;

                    if (buttonText === 'Предпросмотр') {
                        button.addEventListener('click', () => viewModel(rowData.model_id));
                    } else if (buttonText === 'К вариантам') {
                        button.addEventListener('click', () => editModel(rowData.model_id));
                    } else if (buttonText === 'Удалить') {
                        button.addEventListener('click', () => deleteModel(rowData.model_id));
                    }

                    td.appendChild(button);
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);

            // Добавить обработчик события изменения значения ячейки
            table.addEventListener('change', event => {
                const target = event.target;
                if (target.tagName === 'INPUT') {
                    const row = target.parentNode.parentNode;
                    const rowIndex = row.rowIndex;
                    const cellIndex = target.parentNode.cellIndex;
                    const newValue = target.value;

                    const rowId = tableData[rowIndex - 1].model_id;
                    const column = keys[cellIndex];

                    console.log('Обновлено значение поля:', column);
                    console.log('ID:', rowId);
                    console.log('Обновленное значение:', newValue);

                    changeData(rowId, column, newValue);
                }
            });

            // Добавить таблицу в контейнер
            tableContainer.appendChild(table);
        }

        function addModel() {
            fetch('http://localhost:3000/models/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ projectId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        console.log('Успешно добавлен проект');
                        refreshTable();
                    } else {
                        console.log('Ошибка добавления проекта');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }

        function deleteModel(modelId) {
            fetch('http://localhost:3000/models/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ modelId, projectId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        console.log('Успешно удален проект');
                        refreshTable();
                    } else {
                        console.log('Ошибка удаления проекта');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }

        function changeData(modelId, column, newValue) {
            fetch('http://localhost:3000/models/change', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ projectId, modelId, newValue, column })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        console.log('Успешно обновлено значение');
                        refreshTable();
                    } else {
                        console.log('Ошибка обновления проекта');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }

        function viewModel(key) {
            window.open(`../Site.html`);
        }

        function editModel(id) {
            alert('Пока нельзя');
        }

        function logOut() {
            sessionStorage.removeItem('token');
            window.location.href = './Login.html';
        }
    </script>
</body>

</html>