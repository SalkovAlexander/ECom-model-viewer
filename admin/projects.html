<!DOCTYPE html>
<html>

<head>
    <title>Projects</title>
    <style>
        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        input[type="text"] {
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        button{
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <h1>Projects</h1>
    <div id="table-container">
        <!-- Таблица будет отображаться здесь -->
    </div>
    <br></br>
    <button onclick="addProject()">Добавить проект</button>
    <br></br>
    <button onclick="logOut()">Выйти</button>
    <script>
        let catalog;
        

        // Получение токена из sessionStorage
        const token = sessionStorage.getItem('token');

        // Проверка наличия токена
        if (!token) {
            console.log('Токен отсутствует. Выполните аутентификацию.');
            document.body.textContent = 'Токен отсутствует. Выполните аутентификацию.';
        }
        else {
            // Отправка запроса на сервер с заголовком Authorization содержащим токен
            refreshTable();            
        }
        
        function refreshTable()
        {
            let response = new Promise(function (resolve, reject) {
                fetch('http://localhost:3000/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;charset=UTF-8',
                        'Authorization': `Bearer ${token}`
                    }
                })
                    .then(response => response.text())
                    .then(data => {
                        resolve(data);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            });

            response.then(data => {
                catalog = JSON.parse(data);
                console.log(JSON.stringify(catalog)); 
                drawTable(catalog);
            });
        }

        function addProject()
        {
            fetch('http://localhost:3000/projects/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
            })
                .then(response => response.json())
                .then(data => {
                    if(data.status = 'ok')
                    {
                        console.log('Успешно добавлен проект');
                        refreshTable();
                    }
                    else
                        console.log('Ошибка добавления проекта');
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }

        function deleteProject(id)
        {
            fetch('http://localhost:3000/projects/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id })
            })
                .then(response => response.json())
                .then(data => {
                    if(data.status = 'ok')
                    {
                        console.log('Успешно удален проект');
                        refreshTable();
                    }
                    else
                        console.log('Ошибка добавления проекта');
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }

        function viewProject(key)
        {
            window.open('../Site.html?ProjectKey=' + key);
        }

        function editProject(id)
        {
            // alert('Рредактирование проекта с id = '+ id);
        }

        function drawTable(tableData) {
            document.getElementById("table-container").innerHTML = ''
            var tableContainer = document.getElementById('table-container');
            // Создать таблицу
            var table = document.createElement('table');

            const exclude = 'project_id';

            // Создать заголовок таблицы
            var thead = document.createElement('thead');
            var headerRow = document.createElement('tr');
            for (var key in tableData[0]) {
                if (key !== exclude) { // Исключаем поле "project_id"
                    var th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                }
            }

            //Создание столбцов для кнопок
            var th = document.createElement('th')
            th.textContent = 'Предпросмотр';
            headerRow.appendChild(th);
            var th = document.createElement('th')
            th.textContent = 'Изменить';
            headerRow.appendChild(th);
            var th = document.createElement('th')
            th.textContent = 'Удалить';
            headerRow.appendChild(th);

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Создать тело таблицы
            var tbody = document.createElement('tbody');
            tableData.forEach(function (rowData) {
                var row = document.createElement('tr');
                for (var key in rowData) {
                    if (key !== exclude) { // Исключаем поле "project_id"
                        var td = document.createElement('td');
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.value = rowData[key];
                        td.appendChild(input);
                        row.appendChild(td);
                    }
                }
                //Добавление кнопок
                var td = document.createElement('td');
                var button = document.createElement('button');
                button.textContent = 'Предпросмотр';
                button.addEventListener('click', function(event){viewProject(rowData.project_key);});
                td.appendChild(button);
                row.appendChild(td);

                var td = document.createElement('td');
                var button = document.createElement('button');
                button.textContent = 'Изменить';
                button.addEventListener('click', function(event){editProject(rowData.project_id);});
                td.appendChild(button);
                row.appendChild(td);

                td = document.createElement('td');
                button = document.createElement('button');
                button.textContent = 'Удалить';
                button.addEventListener('click', function(event){deleteProject(rowData.project_id);});
                td.appendChild(button);
                row.appendChild(td);

                tbody.appendChild(row);
            });

            table.appendChild(tbody);

            // Добавить обработчик события изменения значения ячейки
            table.addEventListener('change', function (event) {
                var target = event.target;
                if (target.tagName === 'INPUT') {
                    var row = target.parentNode.parentNode;
                    var rowIndex = row.rowIndex;
                    var cellIndex = target.parentNode.cellIndex;
                    var newValue = target.value;
                    // tableData[rowIndex - 1][Object.keys(tableData[0])[cellIndex]] = newValue;

                    var keys = Object.keys(tableData[rowIndex - 1]);
                    //Удаляем нежелательный элемент
                    keys = keys.filter(function (element) {
                        return element !== exclude;
                    });
                    var key = keys[cellIndex];
                    console.log('Обновлено значение поля: ', key);
                    console.log('ID: ', tableData[rowIndex - 1].project_id);
                    console.log('Обновленное значение: ', newValue);
                    changeData(tableData[rowIndex - 1].project_id, key, newValue);
                }
            });
            // Добавить таблицу в контейнер
            tableContainer.appendChild(table);
        }

        function changeData(id, column, newValue) {
            fetch('http://localhost:3000/changedata', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id, column, newValue })
            })
                .then(response => response.json())
                .then(data => {
                    if(data.status = 'ok')
                    {
                        console.log('Успешно обновлено значение');
                        refreshTable();
                    }
                    else
                        console.log('Ошибка добавления проекта');
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                });
        }
    
        function logOut()
        {
            sessionStorage.removeItem('token');
            window.location.href = './Login.html';
        }
    </script>
</body>

</html>